<!DOCTYPE html>
<html>
<head>
  <title>Resume Match Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#9fb0c5;--line:#1e2d49;--acc:#6366f1;--acc2:#22d3ee}
    *{box-sizing:border-box} html,body{margin:0;background:#0b1220;color:#e2e8f0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(2,6,23,.85),rgba(2,6,23,.5));backdrop-filter:blur(8px);border-bottom:1px solid #11213a}
    .nav-inner{max-width:1150px;margin:0 auto;display:flex;align-items:center;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:26px;height:26px;border-radius:8px;background:conic-gradient(from 140deg,#6366f1,#22d3ee,#38bdf8,#6366f1)}
    .links{margin-left:auto;display:flex;gap:12px}
    .link{padding:8px 12px;border-radius:10px;color:#cbd5e1;border:1px solid transparent}
    .link:hover{border-color:#2a3f63;background:#0c1e37}

    .wrap{max-width:1150px;margin:28px auto;padding:0 20px}
    h1{margin:0 0 12px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px}
    .controls input{padding:10px 12px;border-radius:10px;border:1px solid #213456;background:#0b172c;color:#e5edff}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid #213456;background:#0f2039;color:#cfe4ff;font-weight:700;cursor:pointer}
    .btn:hover{background:#0d2443;border-color:#2c4e86}

    .info{margin-bottom:18px;background:#0b1527;border:1px solid #1b2b48;padding:16px;border-radius:12px}
    .result-card{background:linear-gradient(180deg,rgba(148,163,184,.06),rgba(148,163,184,.03));border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:16px}
    .resume-id{font-size:13px;color:#9fb0c5;margin-bottom:4px}
    .result-card h3{margin:0 0 6px}
    .tag{display:inline-block;margin-left:8px;padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,#10b981,#22d3ee);color:#021523;font-weight:900;font-size:12px}
    .collapsible{width:100%;text-align:left;margin-top:10px;padding:10px 12px;border:none;border-radius:10px;background:#0e1a2d;border:1px solid #223a61;color:#cfe4ff;font-weight:700;cursor:pointer}
    .collapsible.active,.collapsible:hover{background:#0d2443;border-color:#2c4e86}
    .content{display:none;padding:10px 12px;background:#0b1526;border-radius:10px;margin-top:6px}
    .download-link{display:inline-block;margin-top:10px;color:#00131f;background:linear-gradient(90deg,#10b981,#22d3ee);padding:8px 12px;border-radius:10px;font-weight:800;text-decoration:none}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span>Match Results</div>
      <div class="links">
        <a class="link" href="/">Home</a>
        <a class="link" href="/match_upload">Matcher</a>
        <a class="link" href="/form-builder">Form Builder</a>
        <a class="link" href="/github_questions">GitHub Q&A</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <h1>Resume Match Results</h1>

    <div class="controls">
      <label>Filter by Match %:</label>
      <input type="number" id="minMatch" placeholder="Min %" />
      <input type="number" id="maxMatch" placeholder="Max %" />
      <button class="btn" onclick="applyFilter()">Apply Filter</button>
    </div>

    <div id="githubLinksSection" class="info">
      <b>All GitHub Repository Links Found:</b>
      <div id="allGithubLinks" style="margin-top:8px;"></div>
    </div>

    <div class="controls" style="margin-bottom:22px">
      <button class="btn" onclick="showAllGithubQuestions()">Show All GitHub Questions</button>
      <button class="btn" onclick="downloadAllCSVs()">Download All CSVs</button>
    </div>

    <div id="resultsContainer"></div>
  </div>

  <script>
    const rawData = JSON.parse(localStorage.getItem('matchResults'))?.matches || [];
    let filtered = rawData;

    function render(data) {
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';
      data.forEach((r, idx) => {
        let obj;
        try { obj = typeof r.match_report === 'string' ? JSON.parse(r.match_report) : r.match_report; }
        catch { obj = { percent_match: 0, description: 'Invalid JSON', positive: '', negative: '' }; }

        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
          <div class="resume-id">Resume ID: <b>${r.pdf_path}</b></div>
          <h3>${r.pdf_path}<span class="tag">${obj.percent_match || 0}% Match</span></h3>
          <p><strong>Description:</strong> ${obj.description || 'N/A'}</p>
          <button class="collapsible">Positive</button>
          <div class="content">${renderNested(obj.positive)}</div>
          <button class="collapsible">Negative</button>
          <div class="content">${renderNested(obj.negative)}</div>
          <button class="collapsible">GitHub Questions</button>
          <div class="content github-analysis" id="githubAnalysis_${idx}"></div>
        `;
        container.appendChild(div);
      });
      const collapsibles = container.querySelectorAll('.collapsible');
      collapsibles.forEach(btn => {
        btn.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
      });
    }

    function renderNested(value) {
      if (Array.isArray(value)) {
        return '<ul style="margin:0;padding-left:18px">' + value.map(item => {
          if (typeof item === 'string') return `<li>${item}</li>`;
          else if (typeof item === 'object')
            return `<li>${Object.entries(item).map(([k,v]) => `<div class='nested'><strong>${k}:</strong> ${Array.isArray(v)? v.join(', '): v}</div>`).join('')}</li>`;
          else return `<li>${JSON.stringify(item)}</li>`;
        }).join('') + '</ul>';
      } else {
        return `<div class='nested'>${value || ''}</div>`;
      }
    }

    function applyFilter() {
      const min = parseInt(document.getElementById('minMatch').value) || 0;
      const max = parseInt(document.getElementById('maxMatch').value) || 100;
      filtered = rawData.filter(r => {
        try { const val = parseInt((typeof r.match_report === 'string' ? JSON.parse(r.match_report) : r.match_report).percent_match); return val >= min && val <= max; }
        catch { return false; }
      });
      render(filtered);
    }

    function showAllGithubQuestions() {
      rawData.forEach((r, idx) => {
        const analysisDiv = document.getElementById(`githubAnalysis_${idx}`);
        if (Array.isArray(r.github_questions) && r.github_questions.length > 0) {
          let html = '';
          r.github_questions.forEach((qset) => {
            html += `<button class='collapsible' style='margin-top:10px;'>Repo: <a href='${qset.repo}' target='_blank'>${qset.repo}</a></button>`;
            html += `<div class='content'>`;
            if (qset.summary) {
              html += `<button class='collapsible' style='margin-top:6px;'>Summary</button>`;
              html += `<div class='content'><div style='margin:6px 0 10px 0;'>${qset.summary}</div></div>`;
            }
            if (qset.questions && qset.questions.length) {
              html += `<button class='collapsible' style='margin-top:6px;'>Questions</button>`;
              html += `<div class='content'><ul style='margin:8px 0 0 0;padding-left:18px;'>` + qset.questions.map(q => `<li>${q}</li>`).join('') + '</ul></div>';
            }
            html += `</div>`;
          });
          analysisDiv.innerHTML = html;
          const inner = analysisDiv.querySelectorAll('.collapsible');
          inner.forEach(btn => btn.addEventListener('click', function(){ this.classList.toggle('active'); const c = this.nextElementSibling; c.style.display = c.style.display === 'block' ? 'none' : 'block'; }));
        } else {
          analysisDiv.innerHTML = '<i>No GitHub questions found for this PDF.</i>';
        }
      });
    }

    function downloadAllCSVs() {
      rawData.forEach((r) => {
        if (Array.isArray(r.github_questions) && r.github_questions.length > 0) {
          let csvContent = 'Repo,Summary,Question\n';
          r.github_questions.forEach(qset => {
            const repo = qset.repo ? '"' + qset.repo.replace(/"/g, '""') + '"' : '';
            const summary = qset.summary ? '"' + qset.summary.replace(/"/g, '""') + '"' : '';
            if (qset.questions && qset.questions.length) {
              qset.questions.forEach(q => { csvContent += `${repo},${summary},"${q.replace(/"/g, '""')}"\n`; });
            } else { csvContent += `${repo},${summary},\n`; }
          });
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `${r.pdf_path.replace(/\.[^/.]+$/, "")}_github_questions_${r.pdf_path}.csv`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
      });
    }

    function renderAllGithubLinks() {
      const urls = [];
      rawData.forEach(r => {
        if (Array.isArray(r.links)) {
          r.links.forEach(link => {
            if (link && typeof link === 'object' && link.uri && /^https:\/\/github.com\/[^/]+\/[^/]+/.test(link.uri)) {
              urls.push(link.uri.match(/^https:\/\/github.com\/[^/]+\/[^/]+/)[0]);
            }
          });
        }
      });
      const uniqueUrls = Array.from(new Set(urls));
      const container = document.getElementById('allGithubLinks');
      container.innerHTML = uniqueUrls.length ? uniqueUrls.map(url => `<a href='${url}' target='_blank' style='margin-right:12px;'>${url}</a>`).join('<br>') : '<i>No GitHub repository links found.</i>';
    }

    render(rawData);
    renderAllGithubLinks();
  </script>
</body>
</html>
