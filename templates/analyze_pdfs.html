<!DOCTYPE html>
<html>
<head>
  <title>Analyze PDFs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#9fb0c5;--line:#1e2d49;--acc:#6366f1;--acc2:#22d3ee}
    *{box-sizing:border-box} html,body{margin:0;background:#0b1220;color:#e2e8f0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(2,6,23,.85),rgba(2,6,23,.5));backdrop-filter:blur(8px);border-bottom:1px solid #11213a}
    .nav-inner{max-width:1000px;margin:0 auto;display:flex;align-items:center;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:26px;height:26px;border-radius:8px;background:conic-gradient(from 140deg,#6366f1,#22d3ee,#38bdf8,#6366f1)}
    .links{margin-left:auto;display:flex;gap:12px}
    .link{padding:8px 12px;border-radius:10px;color:#cbd5e1;border:1px solid transparent}
    .link:hover{border-color:#2a3f63;background:#0c1e37}

    .container{max-width:1000px;margin:28px auto;padding:0 20px}
    .card{background:linear-gradient(180deg,rgba(148,163,184,.06),rgba(148,163,184,.03));border:1px solid var(--line);border-radius:18px;padding:24px;margin-bottom:18px}
    h1{margin:0 0 10px}
    h2{margin:0 0 8px}
    textarea{width:100%;min-height:120px;padding:12px;border:1px solid #213456;border-radius:12px;background:#0b172c;color:#e5edff}
    .pdf-list{max-height:420px;overflow:auto;border:1px solid #20375d;border-radius:12px;padding:8px;background:#0b1526}
    .pdf-item{display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px dashed #172a47}
    .pdf-item:last-child{border-bottom:none}
    .pdf-name{flex:1}
    .pdf-path{color:#7ea2d3;font-size:12px}
    .select-all-controls{display:flex;gap:10px;align-items:center;padding:10px;background:#0e1a2d;border:1px solid #1d2f4f;border-radius:10px;margin-bottom:10px}
    .btn{padding:12px 16px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#6366f1,#22d3ee);color:white}
    .btn-secondary{background:#0f2039;border:1px solid #223a61;color:#cfe4ff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .controls{display:flex;gap:10px;margin-top:12px}
    .loading{display:none;text-align:center;padding:18px;color:#9bd1ff}
    .error{display:none;color:#fecaca;background:#7f1d1d;padding:10px;border-radius:10px;border:1px solid #ef4444;margin-top:10px}
    .kbd{font-family:ui-monospace,Consolas,Menlo,monospace;background:#0b1220;border:1px solid #23375b;border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span>Analyze PDFs</div>
      <div class="links">
        <a class="link" href="/">Home</a>
        <a class="link" href="/form-builder">Form Builder</a>
        <a class="link" href="/match_results">Results</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card"><h1>Analyze PDFs</h1><div style="color:#9fb0c5">Tip: use <span class="kbd">Select All</span> then refine.</div></div>

    <div class="card">
      <h2>Job Description</h2>
      <textarea id="jdText" placeholder="Enter the job description here..."></textarea>
    </div>

    <div class="card">
      <h2>Select PDFs to Analyze</h2>
      <div class="select-all-controls">
        <button type="button" class="btn btn-secondary" onclick="selectAll()">Select All</button>
        <button type="button" class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
        <span id="selectedCount">0 of {{ pdfs|length }} selected</span>
      </div>
      <div class="pdf-list">
        {% for pdf in pdfs %}
        <div class="pdf-item">
          <input type="checkbox" id="pdf_{{ loop.index }}" value="{{ pdf.name }}" checked>
          <label for="pdf_{{ loop.index }}" class="pdf-name">{{ pdf.name }}</label>
          <span class="pdf-path">{{ pdf.path }}</span>
        </div>
        {% endfor %}
      </div>

      <div class="controls">
        <button type="button" class="btn btn-secondary" onclick="goBack()">Back</button>
        <button type="button" class="btn btn-primary" onclick="analyzePDFs()" id="analyzeBtn">Analyze Selected PDFs</button>
        <button type="button" class="btn btn-primary" onclick="analyzeAllPDFs()" id="analyzeAllBtn">Analyze All PDFs</button>
      </div>

      <div class="loading" id="loading"><p>Analyzing PDFs... Please wait...</p></div>
      <div class="error" id="error"></div>
    </div>
  </div>

  <script>
    const formId = '{{ form_id }}';
    const totalPDFs = {{ pdfs|length }};

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = `${count} of ${totalPDFs} selected`;
    }
    function selectAll(){ document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true); updateSelectedCount(); }
    function deselectAll(){ document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); updateSelectedCount(); }
    function getSelectedPDFs(){ return Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value); }
    function goBack(){ window.history.back(); }

    async function analyzePDFs() {
      const jd = document.getElementById('jdText').value.trim();
      const selectedPDFs = getSelectedPDFs();
      if (!jd){ showError('Please enter a job description.'); return; }
      if (selectedPDFs.length === 0){ showError('Please select at least one PDF to analyze.'); return; }

      const analyzeBtn = document.getElementById('analyzeBtn');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');

      analyzeBtn.disabled = true; analyzeBtn.textContent = 'Analyzing...';
      loading.style.display = 'block'; error.style.display = 'none';

      try {
        const formData = new FormData();
        formData.append('jd', jd);
        formData.append('selected_pdfs', JSON.stringify(selectedPDFs));

        const response = await fetch(`/api/v1/analyze_from_excel/${formId}`, { method:'POST', body:formData });
        if (response.ok) {
          const result = await response.json();
          localStorage.setItem('matchResults', JSON.stringify({matches: result}));
          window.location.href = '/match_results';
        } else {
          const errorData = await response.json();
          showError(errorData.error || 'Failed to analyze PDFs.');
        }
      } catch (err) {
        showError('An error occurred while analyzing PDFs.'); console.error(err);
      } finally {
        analyzeBtn.disabled = false; analyzeBtn.textContent = 'Analyze Selected PDFs'; loading.style.display = 'none';
      }
    }
    function showError(message){ const error = document.getElementById('error'); error.textContent = message; error.style.display='block'; }
    function analyzeAllPDFs(){ selectAll(); analyzePDFs(); }

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', updateSelectedCount));
      updateSelectedCount();
    });
  </script>
</body>
</html>
