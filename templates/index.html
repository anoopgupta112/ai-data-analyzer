<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Form Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#9fb0c5;--line:#1e2d49;--acc:#6366f1;--acc2:#22d3ee}
    *{box-sizing:border-box} html,body{margin:0;background:#0b1220;color:#e2e8f0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    /* Nav */
    .nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(2,6,23,.85),rgba(2,6,23,.5));backdrop-filter:blur(8px);border-bottom:1px solid #11213a}
    .nav-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;padding:14px 20px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 140deg,#6366f1,#22d3ee,#38bdf8,#6366f1)}
    .links{margin-left:auto;display:flex;gap:12px}
    .link{padding:8px 12px;border-radius:10px;color:#cbd5e1;border:1px solid transparent}
    .link:hover{border-color:#2a3f63;background:#0c1e37}
    .cta{background:linear-gradient(90deg,#6366f1,#22d3ee);color:#fff}
    /* Layout */
    .wrap{max-width:1200px;margin:28px auto;padding:0 20px}
    .title{font-size:28px;font-weight:800;letter-spacing:.2px;margin-bottom:6px}
    .subtitle{color:var(--muted);margin-bottom:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
    .card{background:linear-gradient(180deg,rgba(148,163,184,.06),rgba(148,163,184,.03));border:1px solid var(--line);border-radius:16px;padding:22px}
    /* Template buttons */
    .template-btn{margin:6px 10px 6px 0;padding:10px 14px;border-radius:12px;background:#0f2039;border:1px solid #20385f;color:#d7e1f0;font-weight:600;cursor:pointer}
    .template-btn:hover{border-color:#2c4e86;background:#0d2443}
    /* Field pills */
    .field-card{display:inline-block;margin:6px 10px 6px 0;padding:10px 14px;border-radius:999px;background:#0f2039;border:1px solid #20385f;color:#d7e1f0;font-weight:600;cursor:pointer;transition:.2s}
    .field-card.selected{background:linear-gradient(90deg,#6366f1,#22d3ee);border-color:transparent}
    label{display:block;font-size:14px;color:#b1c0d6;margin:6px 0 8px}
    .custom-field-row{display:flex;gap:10px;margin-bottom:12px;align-items:center}
    input[type="text"], select{padding:10px 12px;border-radius:10px;border:1px solid #213456;background:#0b172c;color:#e5edff}
    .file-types{min-width:160px}
    .add-custom-btn{background:linear-gradient(90deg,#22d3ee,#6366f1);color:white;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .remove-custom-btn{background:#ef4444;color:white;border:none;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
    .info-label{font-weight:700;color:#bcd1ff;margin:10px 0 6px}
    .curl-box{background:#0b1220;border:1px dashed #23375b;border-radius:12px;padding:14px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;white-space:pre-wrap}
    #formLink{display:inline-block;margin-top:12px;background:linear-gradient(90deg,#22d3ee,#6366f1);padding:12px 16px;border-radius:10px;color:white;font-weight:800}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="dot"></span>Dynamic API Form Generator</div>
      <div class="links">
        <a class="link" href="/">Home</a>
        <a class="link" href="/match_upload">Resume Matcher</a>
        <a class="link cta" href="/form-builder">Form Builder</a>
        <a class="link" href="/match_results">Results</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="title">Build your form</div>
    <div class="subtitle">Select fields, add custom inputs, and generate an API instantly.</div>

    <div id="templateButtons" style="margin-bottom:14px;"></div>

    <div class="grid">
      <div class="card">
        <form id="promptForm">
          <label>Select the data fields you want to collect:</label>
          <div id="fieldsContainer"></div>

          <div style="height:1px;background:#1e2d49;margin:16px 0"></div>

          <label>Other fields:</label>
          <div id="customFields"></div>
          <button type="button" class="add-custom-btn" onclick="addCustomField()">+ Add Custom Field</button>
          <br><br>
          <button type="submit" class="add-custom-btn" style="background:linear-gradient(90deg,#10b981,#22d3ee)">Generate API</button>
        </form>
      </div>

      <div class="card" id="apiInfo" style="display:none">
        <div class="info-label">Your API Endpoint</div>
        <div id="endpointUrl" style="font-weight:800;color:#e5edff"></div>

        <div class="info-label">cURL Example</div>
        <div class="curl-box" id="curlExample"></div>

        <div class="info-label">Preview Form</div>
        <a id="formLink" href="#" target="_blank">Open Form</a>
      </div>
    </div>
  </div>

  <script>
    let customFieldTypes = [];

    async function loadFields() {
      const resp = await fetch('/api/v1/fields');
      const data = await resp.json();
      const fields = data.fields;
      customFieldTypes = data.custom_types;
      const container = document.getElementById('fieldsContainer');
      container.innerHTML = '';
      fields.forEach(field => {
        const btn = document.createElement('span');
        btn.className = 'field-card';
        btn.innerText = field.label;
        btn.dataset.name = field.name;
        btn.onclick = function () { btn.classList.toggle('selected'); };
        container.appendChild(btn);
      });
    }

    async function loadTemplates() {
      const res = await fetch('/api/v1/templates');
      const templates = await res.json();
      const container = document.getElementById('templateButtons');
      templates.forEach(tpl => {
        const btn = document.createElement('button');
        btn.className = 'template-btn';
        btn.innerText = tpl.name;
        btn.onclick = () => applyTemplate(tpl.name);
        container.appendChild(btn);
      });
    }

    async function applyTemplate(name) {
      const res = await fetch(`/api/v1/template_fields/${name}`);
      const { fields } = await res.json();
      document.querySelectorAll('.field-card').forEach(el => el.classList.remove('selected'));
      document.getElementById('customFields').innerHTML = '';

      fields.forEach(tfield => {
        const el = document.querySelector(`.field-card[data-name="${tfield.name}"]`);
        if (el) el.classList.add('selected');
        else {
          const row = document.createElement('div');
          row.className = 'custom-field-row';
          row.innerHTML = `
            <input type="text" placeholder="Field name" class="custom-name" style="width:140px;" value="${tfield.name}" required>
            <select class="custom-type">
              ${customFieldTypes.map(t => `<option value="${t.value}" ${t.value === tfield.data_type ? 'selected' : ''}>${t.label}</option>`).join('')}
            </select>
            <input type="text" class="file-types" placeholder="File types (pdf,doc)" style="display:${tfield.data_type === 'file' ? 'inline-block' : 'none'};" value="${(tfield.accept || []).join(',')}">
            <button type="button" class="remove-custom-btn">&times;</button>
          `;
          row.querySelector('.custom-type').onchange = function () {
            row.querySelector('.file-types').style.display = this.value === 'file' ? '' : 'none';
          };
          row.querySelector('.remove-custom-btn').onclick = () => row.remove();
          document.getElementById('customFields').appendChild(row);
        }
      });
    }

    function addCustomField() {
      const row = document.createElement('div');
      row.className = 'custom-field-row';
      row.innerHTML = `
        <input type="text" placeholder="Field name" class="custom-name" style="width:140px;" required>
        <select class="custom-type"></select>
        <input type="text" class="file-types" placeholder="File types (pdf,doc)" style="display:none" title="Comma separated extensions">
        <button type="button" class="remove-custom-btn">&times;</button>
      `;
      const sel = row.querySelector('.custom-type');
      sel.innerHTML = customFieldTypes.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
      sel.onchange = function(){ row.querySelector('.file-types').style.display = this.value === 'file' ? '' : 'none'; }
      row.querySelector('.remove-custom-btn').onclick = () => row.remove();
      document.getElementById('customFields').appendChild(row);
    }

    document.getElementById('promptForm').onsubmit = async function (e) {
      e.preventDefault();
      const selected = Array.from(document.querySelectorAll('.field-card.selected')).map(x => x.dataset.name);
      const customRows = Array.from(document.querySelectorAll('.custom-field-row'));
      const customFields = customRows.map(row => {
        const name = row.querySelector('.custom-name').value.trim().replace(/\s+/g, '_');
        const data_type = row.querySelector('.custom-type').value;
        let accept = undefined;
        if (data_type === 'file') {
          accept = row.querySelector('.file-types').value.split(',').map(f => f.trim()).filter(f => f);
        }
        return name ? { name, data_type, ...(accept && accept.length ? { accept } : {}) } : null;
      }).filter(Boolean);

      if (selected.length === 0 && customFields.length === 0) {
        alert('Please select at least one field or add custom fields.');
        return;
      }

      const response = await fetch('/api/v1/create_form', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fields: selected, custom_fields: customFields })
      });

      const data = await response.json();
      const url = data.form_url;
      document.getElementById('endpointUrl').innerText = window.location.origin + url;
      let curlFields = '';
      if (data.fields && Array.isArray(data.fields)) {
        curlFields = data.fields.map(f => `  -F "${f.name}=your_value" \\\n`).join('');
      }
      document.getElementById('curlExample').innerText = `curl -X POST \\\n${curlFields}"${window.location.origin}${url}"`;
      document.getElementById('formLink').href = url;
      document.getElementById('formLink').innerText = 'Open Form';
      document.getElementById('apiInfo').style.display = '';
    };

    loadFields();
    loadTemplates();
  </script>
</body>
</html>
